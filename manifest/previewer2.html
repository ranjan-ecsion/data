<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Card Preview</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b5ceb;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .mobile-view-progress-bar-container {
            position: fixed;
            top: 8px;
            left: 15px;
            right: 15px;
            z-index: 1002;
            pointer-events: none;
        }
        
        .card-selection-dropdown .dropdown-toggle {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            color: #333;
            font-weight: 500;
            max-width: 200px;
        }
        
        .card-selection-dropdown .dropdown-toggle:after {
            margin-left: 8px;
        }
        
        .music-btn, .slideshow-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }
        
        .left-move-btn, .right-move-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 999;
        }
        
        .left-move-btn {
            left: 20px;
        }
        
        .right-move-btn {
            right: 20px;
        }
        
        .swipe-hint-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .swipe-hint-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .swipe-hint-content {
            text-align: center;
            max-width: 80%;
        }
        
        .swipe-arrows {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .swipe-hint-text {
            font-size: 18px;
            margin-bottom: 30px;
        }
        
        .swipe-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
        }
        
        .media-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        
        .media-content {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .pdf-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .pdf-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .desktop-preview {
            width: 700px;
            height: 100vh;
            margin: 0 auto;
            position: relative;
            background: #f5f5f5;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.6);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .mobile-preview {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        @media (max-width: 991px) {
            .desktop-preview {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            
            .left-move-btn, .right-move-btn {
                display: none !important;
            }
        }
        
        .dropdown-item.active {
            background-color: rgba(var(--primary-rgb), 0.1);
            color: var(--primary);
        }
        
        .header-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.21);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 10px 10px 10px;
            pointer-events: auto;
        }
        
        .desktop-header {
            left: 50%;
            transform: translateX(-50%);
            width: 700px;
            height: 70px;
        }
        
        .loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .error-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Swipe Hint Overlay -->
    <div id="swipeHintOverlay" class="swipe-hint-overlay">
        <div class="swipe-hint-content">
            <div class="swipe-arrows">
                <i class="fas fa-arrow-left"></i> &nbsp; Swipe &nbsp; <i class="fas fa-arrow-right"></i>
            </div>
            <div class="swipe-hint-text">
                Swipe left or right to navigate between cards
            </div>
            <button id="swipeCloseBtn" class="swipe-close-btn">
                Got it
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div style="font-weight: 500; color: #666;">Loading Preview...</div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-message" style="display: none;">
        <div class="d-flex flex-column justify-content-center align-items-center">
            <div class="mb-4">
                <img src="https://ecsiondevstorage.blob.core.windows.net/wedding-storage/F3BEF3C3-7A0D-46D8-BC12-44AFDAA781AB.png" width="180" height="100" class="h-auto" alt="Member Image">
            </div>
            <h5 class="fw-medium text-center mb-2">The invitation you're trying to view isn't available.</h5>
            <p class="text-center text-muted mb-4">It may have expired or been shared incorrectly. Please contact the hosts for the updated link.</p>
        </div>
    </div>

    <!-- Main Preview Container -->
    <div id="previewContainer" class="mobile-preview">
        <!-- Progress Bar -->
        <div id="progressBarContainer" class="mobile-view-progress-bar-container" style="display: none;">
            <div style="height: 3px; border-radius: 2px; background-color: rgba(255, 255, 255, 0.3); overflow: hidden; position: relative;">
                <div id="progressBar" style="height: 100%; background-color: var(--primary); width: 0%; transition: width 0.1s linear; border-radius: 2px;"></div>
            </div>
        </div>

        <!-- Header with Dropdown and Buttons -->
        <div id="headerContainer" class="header-container">
            <!-- Card Selection Dropdown -->
            <div id="dropdownContainer" style="opacity: 1; transition: opacity 0.3s ease;">
                <div class="dropdown card-selection-dropdown">
                    <button class="btn dropdown-toggle" type="button" id="cardSelectorDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="currentCardName" class="flex-grow-1 text-truncate" style="font-size: 14px;">Loading...</span>
                    </button>
                    <ul id="dropdownMenu" class="dropdown-menu" style="max-height: 300px; overflow-y: auto; min-width: 160px;"></ul>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="d-flex align-items-center gap-2">
                <!-- Music Control Button -->
                <button id="musicControlBtn" class="music-btn" title="Play Music" style="display: none;">
                    <i class="fa-solid fa-volume-xmark"></i>
                </button>

                <!-- Slideshow Control Button -->
                <button id="slideshowControlBtn" class="slideshow-btn" title="Start Slideshow">
                    <i class="fa-solid fa-play"></i>
                </button>
            </div>
        </div>

        <!-- Navigation Arrows (Desktop Only) -->
        <button id="prevBtn" class="left-move-btn" title="Previous Card" style="display: none;">
            <i class="fa-solid fa-chevron-left"></i>
        </button>

        <button id="nextBtn" class="right-move-btn" title="Next Card" style="display: none;">
            <i class="fa-solid fa-chevron-right"></i>
        </button>

        <!-- Media Display Area -->
        <div class="media-container">
            <div id="mediaWrapper" class="media-container">
                <!-- Media will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Audio Element -->
    <audio id="backgroundAudio" loop style="display: none;">
        <source src="https://ecsiondevstorage.blob.core.windows.net/wedding-storage/8145BBB1-4B25-4A5A-AD22-2614C7580EEC.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JSZip for download functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver for download functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Main Application
        class PreviewApp {
            constructor() {
                this.state = {
                    mobileCardsData: {},
                    desktopCardsData: {},
                    currentIndex: 0,
                    isMobile: false,
                    orientation: '',
                    isDownloading: false,
                    isCanvasOpen: false,
                    isLoading: true,
                    hasData: true,
                    isPlaying: false,
                    isWebView: false,
                    isWebBrowser: true,
                    showDropdown: true,
                    isInteractingWithDropdown: false,
                    progress: 0,
                    isSlideshowActive: false,
                    showMusicControl: false
                };

                this.videoRef = null;
                this.audioRef = document.getElementById('backgroundAudio');
                this.touchStartX = 0;
                this.touchEndX = 0;
                this.slideshowTimerRef = null;
                this.cardEntries = [];

                this.init();
            }

            init() {
                this.detectEnvironment();
                this.setupEventListeners();
                this.detectDeviceType();
                this.fetchData();
                this.setupSwipeHint();
            }

            detectEnvironment() {
                // Check for React Native WebView
                const isReactNativeWebView = 
                    window.ReactNativeWebView ||
                    navigator.userAgent.includes("ReactNativeWebView") ||
                    navigator.userAgent.includes("wv") ||
                    (navigator.userAgent.includes("Android") && !navigator.userAgent.includes("Chrome")) ||
                    (navigator.userAgent.includes("Mobile") && navigator.userAgent.includes("Safari") && !navigator.userAgent.includes("Chrome"));

                this.state.isWebView = isReactNativeWebView;
                this.state.isWebBrowser = !isReactNativeWebView;
            }

            setupEventListeners() {
                // Touch events for mobile
                const mediaContainer = document.querySelector('.media-container');
                mediaContainer.addEventListener('touchstart', this.handleTouchStart.bind(this));
                mediaContainer.addEventListener('touchmove', this.handleTouchMove.bind(this));
                mediaContainer.addEventListener('touchend', this.handleTouchEnd.bind(this));

                // Control buttons
                document.getElementById('musicControlBtn').addEventListener('click', this.toggleAudio.bind(this));
                document.getElementById('slideshowControlBtn').addEventListener('click', this.toggleSlideshow.bind(this));
                
                // Navigation buttons
                document.getElementById('prevBtn').addEventListener('click', this.handlePrev.bind(this));
                document.getElementById('nextBtn').addEventListener('click', this.handleNext.bind(this));

                // Window resize
                window.addEventListener('resize', this.handleResize.bind(this));

                // Swipe hint close button
                document.getElementById('swipeCloseBtn').addEventListener('click', this.hideSwipeHint.bind(this));
            }

            setupSwipeHint() {
                // Show swipe hint on first visit
                if (!localStorage.getItem('swipeHintShown')) {
                    document.getElementById('swipeHintOverlay').classList.remove('hidden');
                    localStorage.setItem('swipeHintShown', 'true');
                }
            }

            hideSwipeHint() {
                document.getElementById('swipeHintOverlay').classList.add('hidden');
            }

            detectDeviceType() {
                const isMobile = window.innerWidth < 992;
                const orientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
                
                this.setState({
                    isMobile,
                    orientation
                });

                // Update container classes
                const previewContainer = document.getElementById('previewContainer');
                const headerContainer = document.getElementById('headerContainer');
                
                if (isMobile) {
                    previewContainer.className = 'mobile-preview';
                    headerContainer.classList.remove('desktop-header');
                    document.getElementById('prevBtn').style.display = 'none';
                    document.getElementById('nextBtn').style.display = 'none';
                } else {
                    previewContainer.className = 'desktop-preview';
                    headerContainer.classList.add('desktop-header');
                    document.getElementById('prevBtn').style.display = 'flex';
                    document.getElementById('nextBtn').style.display = 'flex';
                }
            }

            handleResize() {
                this.detectDeviceType();
            }

            async fetchData() {
                // For demo purposes, using static data
                // In a real implementation, you would fetch from your API
                
                const mobileCardsData = {
                    "wedding_card": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/1EEA81FB-F625-4E6A-AA25-C4965104D9A7.mp4",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "portrait",
                    },
                    "Haldi-Mehendi": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/10B145A5-5195-4F1A-8BAC-923A641EA0D1.jpg",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "portrait",
                    },
                    "monogram_card": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/B61811EB-5603-47C0-8A18-5EEB537B5DD9.mp4",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "landscape",
                    },
                    "save_the_date": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/0B04037D-168D-4908-AD29-C440FC9565EB.jpg",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "landscape",
                    }
                };

                const desktopCardsData = {
                    "wedding_card": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/1EEA81FB-F625-4E6A-AA25-C4965104D9A7.mp4",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "portrait",
                    },
                    "Haldi-Mehendi": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/10B145A5-5195-4F1A-8BAC-923A641EA0D1.jpg",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "portrait",
                    },
                    "monogram_card": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/B61811EB-5603-47C0-8A18-5EEB537B5DD9.mp4",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "landscape",
                    },
                    "save_the_date": {
                        "error": null,
                        "status": "success",
                        "card_url": "https://ecsiondevstorage.blob.core.windows.net/wedding-storage/0B04037D-168D-4908-AD29-C440FC9565EB.jpg",
                        "timestamp": "2025-10-31T13:53:48.088Z",
                        "orientation": "landscape",
                    }
                };

                // Simulate API delay
                setTimeout(() => {
                    this.setState({
                        mobileCardsData,
                        desktopCardsData,
                        isLoading: false,
                        hasData: true
                    });

                    this.processCardData();
                    this.renderCurrentCard();
                    this.populateDropdown();

                    // Hide loading spinner
                    document.getElementById('loadingSpinner').style.display = 'none';
                }, 1500);
            }

            processCardData() {
                const cardsData = this.state.isMobile ? this.state.mobileCardsData : this.state.desktopCardsData;
                
                const fixedOrder = [
                    "ganeshvandna_card",
                    "monogram_card",
                    "wedding_card",
                    "save_the_date",
                ];

                const entries = Object.entries(cardsData);

                // Separate fixed cards and event cards
                const fixedCards = [];
                const eventCards = [];

                entries.forEach(([key, value]) => {
                    if (fixedOrder.includes(key)) {
                        fixedCards.push([key, value]);
                    } else {
                        eventCards.push([key, value]);
                    }
                });

                // Sort fixed cards according to the fixed order
                fixedCards.sort(([keyA], [keyB]) => {
                    const indexA = fixedOrder.indexOf(keyA);
                    const indexB = fixedOrder.indexOf(keyB);
                    return indexA - indexB;
                });

                // Sort event cards by their 'order' property (lowest first)
                eventCards.sort(([keyA, valueA], [keyB, valueB]) => {
                    const orderA = valueA.order || 9999;
                    const orderB = valueB.order || 9999;
                    return orderA - orderB;
                });

                // Build the final order: fixed cards in order, but insert event cards between Wedding and Save the Date
                const result = [];

                fixedCards.forEach(([key, value]) => {
                    if (key === "wedding_card") {
                        result.push([key, value]);
                        result.push(...eventCards);
                    } else {
                        result.push([key, value]);
                    }
                });

                this.cardEntries = result;
                
                // Update current index if needed
                if (this.state.currentIndex >= this.cardEntries.length) {
                    this.setState({ currentIndex: 0 });
                }
            }

            getCardDuration(cardKey, cardData) {
                const durationMap = {
                    "wedding_card": 10000,
                    "monogram_card": 3000,
                    "ganeshvandna_card": 3000,
                    "intro_card": 3000,
                    "save_the_date": 10000,
                    "default": 8000,
                };

                const isVideoCard = this.isVideo(cardData?.card_url);
                
                if (isVideoCard) {
                    return durationMap[cardKey] || 12000;
                }
                
                return durationMap[cardKey] || durationMap.default;
            }

            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.updateUI();
            }

            updateUI() {
                // Update current card name
                if (this.cardEntries.length > 0) {
                    const currentCard = this.cardEntries[this.state.currentIndex];
                    document.getElementById('currentCardName').textContent = this.getDisplayName(currentCard[0]);
                }

                // Update progress bar
                document.getElementById('progressBar').style.width = `${this.state.progress}%`;
                
                // Show/hide progress bar container
                if (this.cardEntries.length > 0) {
                    document.getElementById('progressBarContainer').style.display = 'block';
                }

                // Update music control button
                const musicBtn = document.getElementById('musicControlBtn');
                if (this.state.showMusicControl) {
                    musicBtn.style.display = 'block';
                    musicBtn.innerHTML = this.state.isPlaying ? 
                        '<i class="fa-solid fa-volume-high"></i>' : 
                        '<i class="fa-solid fa-volume-xmark"></i>';
                    musicBtn.title = this.state.isPlaying ? 'Pause Music' : 'Play Music';
                } else {
                    musicBtn.style.display = 'none';
                }

                // Update slideshow button
                const slideshowBtn = document.getElementById('slideshowControlBtn');
                slideshowBtn.innerHTML = this.state.isSlideshowActive ? 
                    '<i class="fa-solid fa-pause"></i>' : 
                    '<i class="fa-solid fa-play"></i>';
                slideshowBtn.title = this.state.isSlideshowActive ? 'Stop Slideshow' : 'Start Slideshow';
            }

            getDisplayName(key) {
                if (!key || typeof key !== "string") return "";
                const displayNames = {
                    ganeshvandna_card: "Ganeshvandna",
                    monogram_card: "Monogram",
                    wedding_card: "Wedding",
                    save_the_date: "Save the Date",
                };

                if (displayNames[key]) {
                    return displayNames[key];
                }

                if (key.includes("-")) {
                    return key
                        .split("-")
                        .map((event) => event.replace(/^event/i, "").trim())
                        .map((event) => event.charAt(0).toUpperCase() + event.slice(1))
                        .join(" - ");
                }

                return key
                    .replace(/_/g, " ")
                    .split(" ")
                    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(" ");
            }

            populateDropdown() {
                const dropdownMenu = document.getElementById('dropdownMenu');
                dropdownMenu.innerHTML = '';

                this.cardEntries.forEach(([key, value], index) => {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.className = `dropdown-item ${index === this.state.currentIndex ? 'active' : ''}`;
                    link.href = '#';
                    link.innerHTML = `
                        ${index === this.state.currentIndex ? '<i class="fa-solid fa-check text-primary" style="width: 16px;"></i>' : '<i class="fa-solid fa-check" style="width: 16px; visibility: hidden;"></i>'}
                        <span class="text-truncate">${this.getDisplayName(key)}</span>
                    `;
                    
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleCardSelect(index);
                    });

                    listItem.appendChild(link);
                    dropdownMenu.appendChild(listItem);
                });
            }

            handleCardSelect(index) {
                this.setState({ currentIndex: index });
                this.renderCurrentCard();
                this.populateDropdown();
                
                // Reset progress when manually changing cards
                if (!this.state.isSlideshowActive) {
                    this.setState({ progress: 0 });
                }
            }

            isVideo(url) {
                return /\.(mp4|webm|ogg)$/i.test(url);
            }

            isPDF(url) {
                return /\.(pdf)$/i.test(url);
            }

            renderCurrentCard() {
                const mediaWrapper = document.getElementById('mediaWrapper');
                mediaWrapper.innerHTML = '';

                if (this.cardEntries.length === 0) return;

                const currentCard = this.cardEntries[this.state.currentIndex];
                const cardData = currentCard[1];
                const url = cardData.card_url;

                if (this.isVideo(url)) {
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.className = 'media-content';
                    video.style.background = '#000';
                    mediaWrapper.appendChild(video);
                    this.videoRef = video;
                } else if (this.isPDF(url)) {
                    const pdfContainer = document.createElement('div');
                    pdfContainer.className = 'pdf-placeholder';
                    
                    pdfContainer.innerHTML = `
                        <div class="pdf-icon">ðŸ“„</div>
                        <h4 style="margin-bottom: 10px; font-weight: 600;">PDF Document</h4>
                        <p style="margin-bottom: 8px; opacity: 0.9;">${this.getDisplayName(currentCard[0])}</p>
                        <p style="margin-bottom: 20px; opacity: 0.8; font-size: 14px;">${this.state.isWebBrowser ? 'Ready for download' : 'View in browser to download'}</p>
                        ${this.state.isWebBrowser ? 
                            `<button class="btn btn-light d-flex align-items-center gap-2 download-pdf-btn">
                                <span>ðŸ“¥</span> Download PDF
                            </button>` : ''
                        }
                    `;

                    if (this.state.isWebBrowser) {
                        const downloadBtn = pdfContainer.querySelector('.download-pdf-btn');
                        downloadBtn.addEventListener('click', () => {
                            this.downloadFile(url, `${this.getDisplayName(currentCard[0])}.pdf`);
                        });
                    }

                    mediaWrapper.appendChild(pdfContainer);
                } else {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = 'Selected Media';
                    img.className = 'media-content';
                    mediaWrapper.appendChild(img);
                }
            }

            handleTouchStart(e) {
                this.touchStartX = e.touches[0].clientX;

                // Check if touch is on dropdown
                const isDropdownTouch = e.target.closest('.card-selection-dropdown');
                
                if (isDropdownTouch) {
                    this.state.isInteractingWithDropdown = true;
                    return;
                }
            }

            handleTouchMove(e) {
                this.touchEndX = e.touches[0].clientX;
            }

            handleTouchEnd() {
                if (!this.touchStartX || !this.touchEndX) return;

                const diff = this.touchStartX - this.touchEndX;
                const minSwipeDistance = 50;

                if (Math.abs(diff) >= minSwipeDistance) {
                    if (diff > 0) {
                        this.handleNext();
                    } else {
                        this.handlePrev();
                    }
                }

                // Reset values
                this.touchStartX = 0;
                this.touchEndX = 0;
            }

            handlePrev() {
                const newIndex = this.state.currentIndex > 0 ? 
                    this.state.currentIndex - 1 : 
                    this.cardEntries.length - 1;
                
                this.setState({ currentIndex: newIndex });
                this.renderCurrentCard();
                this.populateDropdown();
                
                // Reset progress when manually changing cards
                if (!this.state.isSlideshowActive) {
                    this.setState({ progress: 0 });
                }
            }

            handleNext() {
                const newIndex = this.state.currentIndex < this.cardEntries.length - 1 ? 
                    this.state.currentIndex + 1 : 
                    0;
                
                this.setState({ currentIndex: newIndex });
                this.renderCurrentCard();
                this.populateDropdown();
                
                // Reset progress when manually changing cards
                if (!this.state.isSlideshowActive) {
                    this.setState({ progress: 0 });
                }
            }

            toggleSlideshow() {
                const newSlideshowState = !this.state.isSlideshowActive;
                this.setState({ 
                    isSlideshowActive: newSlideshowState,
                    showMusicControl: newSlideshowState
                });

                // Auto-play music when slideshow starts
                if (newSlideshowState && this.audioRef) {
                    this.audioRef.volume = 0.7;
                    this.audioRef.play().then(() => {
                        this.setState({ isPlaying: true });
                    }).catch(error => {
                        console.log("Audio play failed:", error);
                    });

                    // Start slideshow progress
                    this.startSlideshowProgress();
                } else if (!newSlideshowState && this.audioRef) {
                    // Stop music when slideshow stops
                    this.audioRef.pause();
                    this.audioRef.currentTime = 0;
                    this.setState({ isPlaying: false });

                    // Stop slideshow progress
                    this.stopSlideshowProgress();
                }
            }

            startSlideshowProgress() {
                // Clear any existing timer
                if (this.slideshowTimerRef) {
                    clearInterval(this.slideshowTimerRef);
                }

                // Reset progress
                this.setState({ progress: 0 });

                // Get current card's duration
                const currentCard = this.cardEntries[this.state.currentIndex];
                const currentDuration = this.getCardDuration(currentCard[0], currentCard[1]);

                this.slideshowTimerRef = setInterval(() => {
                    this.setState({ 
                        progress: this.state.progress + (100 / (currentDuration / 100))
                    });

                    if (this.state.progress >= 100) {
                        // Move to next card when progress completes
                        if (this.state.currentIndex < this.cardEntries.length - 1) {
                            this.setState({ currentIndex: this.state.currentIndex + 1 });
                        } else {
                            // Loop back to first card
                            this.setState({ currentIndex: 0 });
                        }
                        this.renderCurrentCard();
                        this.populateDropdown();
                        this.setState({ progress: 0 });
                    }
                }, 100);
            }

            stopSlideshowProgress() {
                if (this.slideshowTimerRef) {
                    clearInterval(this.slideshowTimerRef);
                    this.slideshowTimerRef = null;
                }
                this.setState({ progress: 0 });
            }

            async toggleAudio() {
                if (!this.audioRef) return;

                try {
                    if (this.state.isPlaying) {
                        this.audioRef.pause();
                        this.setState({ isPlaying: false });
                    } else {
                        this.audioRef.volume = 0.7;
                        await this.audioRef.play();
                        this.setState({ isPlaying: true });
                    }
                } catch (error) {
                    console.log("Audio playback failed:", error);
                }
            }

            async downloadFile(url, filename) {
                if (this.state.isWebView) {
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(
                            JSON.stringify({
                                type: "download",
                                url: url,
                                filename: filename,
                            })
                        );
                    }
                    alert("Download feature is available in web browser only.");
                    return;
                }

                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(blobUrl);
                } catch (error) {
                    console.error("Download failed:", error);
                    alert("Download failed. Please try again.");
                }
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new PreviewApp();
        });
    </script>
</body>
</html>